-- ðŸ›‘ FechaAgotamientoEstimado â€” Primera fecha en que el stock proyectado se agota
--
-- Esta medida busca la primera fecha futura donde el stock proyectado es cero o negativo.
-- Es Ãºtil para anticipar roturas de stock en escenarios logÃ­sticos o de inventario.

FechaAgotamientoEstimado =
CALCULATE(
    MIN(DimTiempo[Fecha]),
    FILTER(
        ALL(DimTiempo),
        CALCULATE(
            SUM(FactEntradas[Cantidad]) - SUM(FactSalidas[Cantidad])
        ) <= 0
        && DimTiempo[Fecha] >= TODAY()
    )
)

-- ðŸ§  ExplicaciÃ³n paso a paso:
-- - ALL(DimTiempo): ignora cualquier filtro previo de fecha
-- - CALCULATE(...): recalcula el stock neto (entradas - salidas)
-- - Se filtran solo las fechas desde hoy en adelante
-- - Se buscan aquellas donde el stock neto acumulado sea <= 0
-- - MIN(...): devuelve la primera de esas fechas (agotamiento)

-- ðŸ“Š Resultado:
-- Si el stock actual se agota el 12 de agosto, la medida devuelve esa fecha.
-- Si nunca se agota, devuelve BLANK().

-- âœ… CuÃ¡ndo usar esta medida:
-- - Para alertas anticipadas en inventario o producciÃ³n
-- - Para dashboards de logÃ­stica o gestiÃ³n de suministros
-- - Combinada con la fecha actual, permite calcular dÃ­as restantes de stock

-- ðŸ’¡ Consejo:
-- Puedes crear una medida complementaria: 
--   DÃ­asHastaAgotamiento = DATEDIFF(TODAY(), [FechaAgotamientoEstimado], DAY)
-- Para mostrar cuÃ¡ntos dÃ­as faltan para la ruptura de stock.
